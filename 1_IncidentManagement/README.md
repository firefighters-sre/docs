# 1. Planejando a Resposta a um Incidente
A resposta a incidentes √© um pilar crucial da engenharia moderna de software e opera√ß√µes. Assegura que, quando problemas surgem, h√° uma forma estruturada de abord√°-los, minimizar impactos e aprender com o ocorrido.

## 1.1 Introdu√ß√£o ao Gerenciamento de Incidentes
Todos desejam que seus servi√ßos funcionem perfeitamente o tempo todo, mas vivemos em um mundo imperfeito onde interrup√ß√µes ocorrem. Gerenciar um incidente significa coordenar esfor√ßos em situa√ß√µes de emerg√™ncia e assegurar que a comunica√ß√£o flua entre os participantes e os interessados no progresso do incidente.
## **Princ√≠pios Fundamentais da Resposta a Incidentes**
Antes de mergulhar nos detalhes, √© vital entender os princ√≠pios centrais:

1. **Linha Clara de Comando**: Garante que, durante o caos de um incidente, n√£o haja ambiguidade sobre quem toma decis√µes.
2. **Pap√©is Bem Definidos**: Cada pessoa envolvida deve saber suas responsabilidades.
3. **Documenta√ß√£o em Tempo Real**: Registre as a√ß√µes, decis√µes e etapas de depura√ß√£o conforme acontecem.
4. **Declare Incidentes Precocemente**: Melhor comunicar demais do que de menos.

## **O que √© um Incidente?**
Um incidente refere-se a qualquer evento inesperado que interrompe ou reduz a qualidade de um servi√ßo, afetando adversamente a experi√™ncia dos usu√°rios. Pode variar desde falhas sutis, como degrada√ß√£o de desempenho, at√© interrup√ß√µes completas do servi√ßo. Um *incidente maior*, por outro lado, √© uma situa√ß√£o mais grave, geralmente envolvendo v√°rias equipes para sua resolu√ß√£o devido ao seu impacto significativo na opera√ß√£o normal do sistema ou na experi√™ncia do cliente.

## **Sistema de Comando de Incidentes (ICS)**
Originado entre bombeiros na Calif√≥rnia dos anos 70 para combater inc√™ndios florestais, o ICS √© um framework de gerenciamento de resposta a emerg√™ncias que permite uma resposta coordenada e eficaz. A beleza do ICS reside na sua estrutura modular, o que significa que ele pode ser escalado ou reduzido dependendo das necessidades do incidente. 

Os princ√≠pios fundamentais do ICS incluem:

- **Organiza√ß√£o Padr√£o**: Estabelece uma estrutura hier√°rquica e definida para o gerenciamento e coordena√ß√£o.
- **Terminologia Comum**: Usa terminologia padr√£o para evitar mal-entendidos.
- **Procedimentos Integrados**: Incorpora procedimentos e pol√≠ticas aceitas para efici√™ncia.

Este sistema foi adaptado pelas empresas de tecnologia para lidar com falhas de sistema, com foco em tr√™s Cs:

- **Coordenar** esfor√ßos de resposta.
- **Comunicar** efetivamente dentro e fora da organiza√ß√£o.
- **Controlar** a resposta ao incidente.

## **Principais Pap√©is na Resposta a Incidentes**
1. **Comandante do Incidente (CI)**: A figura central da resposta ao incidente. O CI tem a vis√£o geral da situa√ß√£o, toma decis√µes estrat√©gicas e garante que os recursos sejam alocados corretamente.
2. **L√≠der de Opera√ß√µes (LO)**: Este √© o "fazedor". O LO √© respons√°vel pela execu√ß√£o das estrat√©gias definidas pelo CI, trabalhando diretamente na resolu√ß√£o do incidente.
3. **L√≠der de Comunica√ß√µes (LC)**: Garante que todas as partes interessadas, internas e externas, sejam informadas sobre o status do incidente e quaisquer impactos associados.

## **Severidade do Incidente**
A severidade de um incidente ajuda a determinar a urg√™ncia e o tipo de resposta necess√°rios:

- **SEV-1**: Incidentes que t√™m um impacto cr√≠tico nos clientes ou na opera√ß√£o do sistema.
- **SEV-2**: Problemas significativos que afetam muitos usu√°rios, mas n√£o s√£o t√£o cr√≠ticos quanto um SEV-1.
- **SEV-3**: Problemas que t√™m um impacto moderado e podem ter solu√ß√µes de contorno.
- **SEV-4**: Pequenas interrup√ß√µes que t√™m solu√ß√µes de contorno f√°ceis.
- **SEV-5**: Problemas m√≠nimos ou est√©ticos que n√£o afetam a funcionalidade principal.

## **Peacetime x Wartime: Adapta√ß√£o e Inova√ß√£o no Gerenciamento de Incidentes**
A ideia de Peacetime e Wartime, embora inicialmente introduzida no contexto da lideran√ßa em neg√≥cios, tem aplica√ß√µes interessantes no mundo da resposta a incidentes.

### **Peacetime em Resposta a Incidentes**
Durante o **Peacetime**, os sistemas s√£o est√°veis e as equipes se concentram na otimiza√ß√£o e na prepara√ß√£o. √â um momento para treinamento, revis√£o de processos e melhorias proativas. O foco √© na preven√ß√£o: 

- Realiza√ß√£o de simula√ß√µes de incidentes.
- Treinamentos regulares para equipes.
- Avalia√ß√£o e aprimoramento de ferramentas e plataformas.

### **Wartime em Resposta a Incidentes**
**Wartime** √© quando um incidente ocorre. A prioridade √© a resolu√ß√£o r√°pida e eficaz do incidente. Os protocolos s√£o mais r√≠gidos, e a comunica√ß√£o √© frequentemente centralizada para evitar desinforma√ß√£o:

- Acionamento imediato de equipes especializadas.
- Comunica√ß√£o r√°pida com stakeholders.
- An√°lise post-mortem ap√≥s a resolu√ß√£o do incidente para aprender e evitar repeti√ß√µes.

## **Conex√µes com o Mundo Real e Resposta a Incidentes**
A gest√£o estruturada de incidentes n√£o √© exclusividade do universo da tecnologia. Diversos setores cr√≠ticos t√™m seus pr√≥prios protocolos de resposta a incidentes, demonstrando a universalidade desses princ√≠pios. Vejamos como se manifestam em alguns setores vitais:

### **Bombeiros**
Os bombeiros s√£o a linha de frente quando se trata de emerg√™ncias, desde inc√™ndios a desastres naturais e resgates. Sua resposta a incidentes √© meticulosamente treinada e aprimorada ao longo dos anos. Aqui est√° uma vis√£o detalhada de como eles respondem a incidentes:

- **Prepara√ß√£o**: De acordo com a National Fire Protection Association (NFPA) dos EUA, os bombeiros s√£o obrigados a passar por um m√≠nimo de 600 horas de treinamento inicial antes de serem considerados operacionais. Esses treinamentos incluem simula√ß√µes de inc√™ndio reais, treinamento m√©dico de emerg√™ncia e treinamento de resgate.

- **Resposta**: Um estudo publicado no *Journal of Safety Research* destacou que a comunica√ß√£o √© um dos fatores mais cr√≠ticos na resposta eficaz dos bombeiros a inc√™ndios. Assim como um CI em TI, o comandante no local assume a lideran√ßa, garantindo comunica√ß√£o eficaz e delega√ß√£o de tarefas.

**1. Recebimento e Despacho**
Quando um chamado √© recebido, os detalhes do incidente s√£o rapidamente avaliados e transmitidos √†s equipes relevantes. Isso √© feito por um sistema de despacho centralizado que determina a localiza√ß√£o do incidente e envia a unidade mais pr√≥xima e mais adequada.

**2. Avalia√ß√£o Inicial no Local**
Ao chegarem ao local, os bombeiros realizam uma avalia√ß√£o inicial para determinar a gravidade do incidente. Isso envolve identificar fontes de perigo, poss√≠veis v√≠timas e a melhor abordagem para lidar com a situa√ß√£o.

**3. Estabelecimento de Comando**
Um Comandante de Incidente (CI) √© designado para liderar a opera√ß√£o. Semelhante ao CI em TI, este l√≠der toma decis√µes estrat√©gicas, coordena equipes e comunica-se com outros servi√ßos de emerg√™ncia.

**4. Prioridades de Resposta**
Os bombeiros seguem um conjunto padr√£o de prioridades, muitas vezes resumidas como "Vida, Propriedade, Ambiente".

- **Vida**: O resgate e o atendimento m√©dico das v√≠timas s√£o a maior prioridade.
- **Propriedade**: Isso envolve salvar edif√≠cios, casas e outros bens.
- **Ambiente**: Minimizar danos ao meio ambiente, como a preven√ß√£o da propaga√ß√£o de inc√™ndios florestais.

**5. A√ß√£o e Mitiga√ß√£o**
Dependendo do incidente, v√°rias t√°ticas podem ser empregadas, desde combater um inc√™ndio com √°gua ou espuma at√© t√©cnicas de resgate em altura ou em √°gua. Equipamentos especializados, como escadas a√©reas ou ferramentas de desencarceramento, podem ser usados.

**6. Comunica√ß√£o Constante**
A comunica√ß√£o √© vital. A equipe no local est√° em constante comunica√ß√£o com a central de despacho e outras equipes, garantindo que todos estejam cientes da situa√ß√£o e de quais recursos est√£o dispon√≠veis.

**7. Desmobiliza√ß√£o e An√°lise**
Uma vez que o incidente esteja sob controle, as equipes come√ßam a se desmobilizar. Equipamentos s√£o recolhidos e verificados, e ve√≠culos s√£o reabastecidos e preparados para a pr√≥xima chamada. Finalmente, muitos departamentos de bombeiros realizam an√°lises p√≥s-incidente para aprender com o evento e melhorar futuras respostas.

### **Equipes M√©dicas de Emerg√™ncia**
As equipes m√©dicas de emerg√™ncia (EMT, em ingl√™s) s√£o as primeiras a responder em situa√ß√µes m√©dicas cr√≠ticas, desde acidentes de tr√¢nsito a crises card√≠acas em locais p√∫blicos. Seu treinamento e protocolos s√£o rigorosos para garantir a presta√ß√£o de cuidados m√©dicos imediatos e eficazes.

- **Prepara√ß√£o**: Os EMTs passam por um treinamento rigoroso que abrange uma ampla variedade de cen√°rios m√©dicos de emerg√™ncia, ensinando-os a responder rapidamente e eficazmente.

- **Resposta**: Em caso de emerg√™ncia, a resposta deve ser imediata. Cada segundo conta quando vidas est√£o em risco.

1. **Recebimento e Despacho**: Uma chamada √© recebida e avaliada rapidamente, enviando a equipe mais pr√≥xima e adequada para o local.
2. **Avalia√ß√£o no Local**: Ao chegarem, os EMTs avaliam rapidamente a situa√ß√£o e decidem o melhor curso de a√ß√£o.
3. **Presta√ß√£o de Cuidados Imediatos**: Eles prestam os primeiros socorros necess√°rios, estabilizando o paciente o m√°ximo poss√≠vel.
4. **Transporte**: Se necess√°rio, o paciente √© transportado para o hospital mais pr√≥ximo, enquanto recebe cuidados cont√≠nuos.
5. **Transfer√™ncia de Cuidados**: Ao chegar ao hospital, a responsabilidade √© transferida para a equipe m√©dica de plant√£o.
6. **Retorno e Prepara√ß√£o**: A equipe retorna √† base, preparando-se para a pr√≥xima chamada.

### **Pilotos e Controladores de Tr√°fego A√©reo**
O tr√°fego a√©reo √© uma dan√ßa complexa que exige coordena√ß√£o precisa entre pilotos e controladores de tr√°fego a√©reo. A seguran√ßa √© primordial, e os protocolos s√£o rigorosamente seguidos para garantir que todos os voos decolem, voem e aterrissem com seguran√ßa.

- **Prepara√ß√£o**: Tanto pilotos quanto controladores passam por treinamento intensivo, com foco na seguran√ßa e na comunica√ß√£o eficaz.

- **Resposta**: No caso de uma emerg√™ncia, a resposta deve ser coordenada e r√°pida para garantir a seguran√ßa de todos os envolvidos.

1. **Comunica√ß√£o**: Esta √© a chave. Pilotos e controladores devem estar em comunica√ß√£o constante, especialmente em situa√ß√µes de emerg√™ncia.
2. **Monitoramento Cont√≠nuo**: Controladores monitoram o tr√°fego a√©reo em tempo real, garantindo que todas as aeronaves estejam seguras.
3. **Coordena√ß√£o em Emerg√™ncias**: Em caso de emerg√™ncia, como um avi√£o precisando de pouso imediato, os controladores coordenam o espa√ßo a√©reo para permitir que isso aconte√ßa.
4. **Prioriza√ß√£o**: Voos em situa√ß√£o de emerg√™ncia s√£o priorizados para garantir a seguran√ßa de todos.
5. **Coordena√ß√£o com Outros Entes**: Em caso de emerg√™ncias maiores, controladores podem precisar coordenar com outros aeroportos ou servi√ßos de emerg√™ncia.
6. **An√°lise P√≥s-Incidente**: Ap√≥s qualquer incidente, uma an√°lise √© feita para entender o que aconteceu e como melhorar no futuro.

## 1.2 Plataformas e Ferramentas
- **Passo-a-Passo**:
  1. **Vis√£o Geral**: Introdu√ß√£o ao sistema Firefighters SRE, um sistema projetado para simular a gest√£o e monitoramento de um edif√≠cio. Diferentes microservi√ßos s√£o respons√°veis por monitorar e gerenciar aspectos espec√≠ficos, como acesso de pessoas, mobilidade, ambiente e seguran√ßa do edif√≠cio.
    - **Stack Tecnol√≥gica**:
       - Microservi√ßos: Quarkus
       - Plataforma de Mensagens: AMQ Streams (Kafka) e Red Hat Fuse (Apache Camel)
       - Banco de Dados: PostgreSQL
       - Implanta√ß√£o: OpenShift (Kubernetes com Helm charts)
       - Monitoramento e Rastreamento: Prometheus, Jaeger e Grafana
    - **Microservi√ßos**:
       - üõéÔ∏è [**Access Microservice (concierge-app)**](https://github.com/firefighters-sre/concierge-app): Gerencia a entrada e sa√≠da de indiv√≠duos do edif√≠cio.
       - üö∂‚Äç‚ôÇÔ∏èüîù [**Mobility Microservice (mobility-app)**](https://github.com/firefighters-sre/mobility-app): Monitora e gerencia a utiliza√ß√£o de escadas e elevadores.
       - üè† [**Building Microservice (building-app)**](https://github.com/firefighters-sre/building-app): Gerencia informa√ß√µes relacionadas ao edif√≠cio, como temperatura, qualidade do ar e ocupa√ß√£o do piso.
    - **T√≥picos Kafka**:
       - `Lobby (lobby)`: Coleta eventos relacionados √†s atividades no sagu√£o do edif√≠cio.
       - `Lobby (lobby)`: Coleta eventos relacionados √†s atividades no sagu√£o do edif√≠cio.
       - `Entrance (entrance)`: Manipula eventos p√≥s-processamento do Lobby, marcando a entrada de indiv√≠duos no edif√≠cio.
       - `Elevator (elevator)`: Captura eventos associados √†s opera√ß√µes do elevador.
       - `Stairs (stairs)`: Coleta dados sobre o uso de escadas.
       - `Exit (exit)`: Coleta eventos relacionados √† sa√≠da de indiv√≠duos do edif√≠cio.
       - `External (external)`: Coleta eventos originados de sistemas ou dispositivos externos ao edif√≠cio.
  2. **Testes Unit√°rios com Quarkus**:
    - Demonstra√ß√£o de como configurar e executar `testes unit√°rios` na aplica√ß√£o quarkus `concierge-app`.
### Testes Unit√°rios com Quarkus
Al√©m dos testes unit√°rios padr√£o, um dos testes a ser observado √© o `testAccess` no arquivo [`AccessLogResourceTest.java`](
https://github.com/firefighters-sre/concierge-app/blob/main/src/test/java/com/redhat/quarkus/resources/AccessLogResourceTest.java). Vamos detalhar este teste:
##### testAccess: Verificando a Integra√ß√£o com Kafka
Este teste valida a capacidade do servi√ßo `concierge-app` de enviar registros de acesso ao t√≥pico Kafka `entrance` e, em seguida, consumir esses registros para verifica√ß√£o.

1. **Inicializa√ß√£o e Subscri√ß√£o ao T√≥pico Kafka**:
    ```java
    logConsumer.subscribe(Collections.singleton("entrance"));
    ```
   O teste come√ßa se inscrevendo no t√≥pico Kafka `entrance` para ouvir as mensagens que ser√£o produzidas.

2. **Prepara√ß√£o dos Dados**:
    ```java
    AccessLog logToSend = new AccessLog(1L, "1");
    ```
   Um novo objeto `AccessLog` √© criado para simular um registro de acesso que ser√° enviado ao t√≥pico Kafka.

3. **Chamada ao Endpoint e Envio de Dados**:
    ```java
    given()
      .when()
      .contentType(ContentType.JSON)
      .body(logToSend)
      .post("/access")
      .then()
      .statusCode(204);
    ```
   Aqui, o endpoint `/access` √© chamado com o objeto `AccessLog` preparado. A resposta esperada √© um HTTP 204, indicando sucesso sem retorno.

4. **Consumo e Verifica√ß√£o dos Dados**:
    ```java
    ConsumerRecords<String, MoveLog> records = logConsumer.poll(Duration.ofMillis(10000));
    MoveLog receivedLog = records.records("entrance").iterator().next().value();
    ```
   O teste aguarda at√© 10 segundos para consumir a mensagem do t√≥pico `entrance`. Uma vez consumida, ele extrai o valor da mensagem como um objeto `MoveLog`.

5. **Valida√ß√£o**:
    ```java
    assertEquals(logToSend.getPersonId(), receivedLog.getPersonId());
    assertEquals(logToSend.getDestination(), receivedLog.getDestination());
    assertEquals("elevator", receivedLog.getPreferredRoute());
    ```
   Finalmente, o teste valida se os dados consumidos do t√≥pico Kafka correspondem aos dados enviados originalmente, verificando o ID da pessoa, o destino e a rota preferida.

Este teste garante que o servi√ßo `concierge-app` esteja corretamente integrado com o Kafka, sendo capaz de produzir e consumir mensagens conforme esperado.
